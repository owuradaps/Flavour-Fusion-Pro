{% extends 'base.html' %}

{% block title %}{% if form.instance.pk %}Edit Recipe{% else %}Create Recipe{% endif %} - FlavourFusion{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h2 class="mb-4">{% if form.instance.pk %}Edit Recipe{% else %}Create Recipe{% endif %}</h2>
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        
        <div class="row">
            <!-- Main Recipe Details -->
            <div class="col-md-4">
                <h3>Recipe Details</h3>
                <div class="form-group">
                    {{ form.title.label_tag }}
                    {{ form.title }}
                </div>
                <div class="form-group mt-3">
                    {{ form.description.label_tag }}
                    {{ form.description }}
                </div>
                <div class="form-group mt-3">
                    {{ form.image.label_tag }}
                    {{ form.image }}
                </div>
                <div class="form-group mt-3">
                    {{ form.category.label_tag }}
                    {{ form.category }}
                </div>
            </div>
            
            <!-- Ingredients -->
            <div class="col-md-4">
                <h3>Ingredients</h3>
                {{ ingredient_formset.management_form }}
                <div id="ingredient-formset">
                    {% for ingredient_form in ingredient_formset %}
                        <div class="ingredient-form mb-3">
                            {% for field in ingredient_form %}
                                <div class="form-group">
                                    {{ field.label_tag }}
                                    {{ field }}
                                </div>
                            {% endfor %}
                        </div>
                    {% endfor %}
                </div>
                <button type="button" id="add-ingredient" class="btn btn-secondary btn-sm mt-2">Add Ingredient</button>
            </div>
            
            <!-- Preparation Steps -->
            <div class="col-md-4">
                <h3>Preparation Steps</h3>
                {{ step_formset.management_form }}
                <div id="step-formset">
                    {% for step_form in step_formset %}
                        <div class="step-form mb-3">
                            {% for field in step_form %}
                                <div class="form-group">
                                    {{ field.label_tag }}
                                    {{ field }}
                                </div>
                            {% endfor %}
                        </div>
                    {% endfor %}
                </div>
                <button type="button" id="add-step" class="btn btn-secondary btn-sm mt-2">Add Step</button>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <button type="submit" class="btn btn-primary">{% if form.instance.pk %}Update{% else %}Create{% endif %} Recipe</button>
            </div>
        </div>
    </form>
</div>

{% block extra_js %}
<script>
    function addForm(prefix) {
        var formCount = parseInt(document.getElementById(`id_${prefix}-TOTAL_FORMS`).value);
        var newForm = document.getElementById(`${prefix}-form-template`).cloneNode(true);
        newForm.innerHTML = newForm.innerHTML.replace(/__prefix__/g, formCount);
        newForm.setAttribute('class', `${prefix}-form mb-3`);
        newForm.style.display = '';
        document.getElementById(`${prefix}-formset`).appendChild(newForm);
        document.getElementById(`id_${prefix}-TOTAL_FORMS`).value = formCount + 1;
    }

    document.getElementById('add-ingredient').addEventListener('click', function() {
        addForm('ingredient');
    });

    document.getElementById('add-step').addEventListener('click', function() {
        addForm('step');
    });
</script>

<!-- Templates for new forms -->
<div id="ingredient-form-template" style="display:none;">
    {% for field in ingredient_formset.empty_form %}
        <div class="form-group">
            {{ field.label_tag }}
            {{ field }}
        </div>
    {% endfor %}
</div>

<div id="step-form-template" style="display:none;">
    {% for field in step_formset.empty_form %}
        <div class="form-group">
            {{ field.label_tag }}
            {{ field }}
        </div>
    {% endfor %}
</div>
{% endblock %}

{% endblock %}