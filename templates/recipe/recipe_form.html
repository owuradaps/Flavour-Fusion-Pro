{% extends 'base.html' %}

{% block title %}{% if form.instance.pk %}Edit Recipe{% else %}Create Recipe{% endif %} - FlavourFusion{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h2 class="mb-4">{% if form.instance.pk %}Edit Recipe{% else %}Create Recipe{% endif %}</h2>
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        
        <div class="row">
            <!-- Main Recipe Details -->
            <div class="col-md-4">
                <h3>Recipe Details</h3>
                {{ form.as_p }}
            </div>
            
            <!-- Ingredients -->
            <div class="col-md-4">
                <h3>Ingredients</h3>
                {{ ingredient_formset.management_form }}
                <div id="ingredient-formset">
                    {% for ingredient_form in ingredient_formset %}
                        <div class="ingredient-form mb-3">
                            {{ ingredient_form.as_p }}
                        </div>
                    {% endfor %}
                </div>
                <button type="button" id="add-ingredient" class="btn btn-secondary btn-sm mt-2">Add Ingredient</button>
            </div>
            
            <!-- Preparation Steps -->
            <div class="col-md-4">
                <h3>Preparation Steps</h3>
                {{ step_formset.management_form }}
                <div id="step-formset">
                    {% for step_form in step_formset %}
                        <div class="step-form mb-3">
                            {{ step_form.as_p }}
                        </div>
                    {% endfor %}
                </div>
                <button type="button" id="add-step" class="btn btn-secondary btn-sm mt-2">Add Step</button>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <button type="submit" class="btn btn-primary">{% if form.instance.pk %}Update{% else %}Create{% endif %} Recipe</button>
            </div>
        </div>
    </form>
</div>

<!-- Templates for new forms -->
<div id="ingredient-form-template" style="display:none;">
    <div class="ingredient-form mb-3">
        {{ ingredient_formset.empty_form.as_p }}
    </div>
</div>

<div id="step-form-template" style="display:none;">
    <div class="step-form mb-3">
        {{ step_formset.empty_form.as_p }}
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const addIngredientBtn = document.getElementById('add-ingredient');
    const addStepBtn = document.getElementById('add-step');
    const ingredientFormset = document.getElementById('ingredient-formset');
    const stepFormset = document.getElementById('step-formset');

    function addForm(formsetDiv, prefix) {
        const totalForms = document.getElementById(`id_${prefix}-TOTAL_FORMS`);
        const newIndex = parseInt(totalForms.value);
        const template = document.getElementById(`${prefix}-form-template`).cloneNode(true);
        template.innerHTML = template.innerHTML.replace(/__prefix__/g, newIndex);
        template.style.display = 'block';
        formsetDiv.appendChild(template.firstElementChild);
        totalForms.value = newIndex + 1;
    }

    if (addIngredientBtn) {
        addIngredientBtn.addEventListener('click', function() {
            addForm(ingredientFormset, 'ingredient');
        });
    }

    if (addStepBtn) {
        addStepBtn.addEventListener('click', function() {
            addForm(stepFormset, 'step');
        });
    }
});
</script>
{% endblock %}